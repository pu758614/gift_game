# 排隊機制測試說明

## 測試概述

這個測試腳本驗證 Imagen 4.0 並發限制排隊機制的正確性。

## 測試項目

### ✅ 測試 1: 並發限制驗證
- **目的**: 確認 Semaphore 正確限制並發數量為 5 個
- **方法**: 同時啟動 10 個請求，驗證最多只有 5 個同時執行
- **結果**: ✅ 通過 - 所有 10 個請求都成功完成，且遵守並發限制

### ✅ 測試 2: 重試機制驗證
- **目的**: 確認失敗時會自動重試最多 2 次
- **方法**: 模擬 API 前兩次失敗，第三次成功
- **結果**: ✅ 通過 - 重試機制在 Docker 環境正常運作

### ✅ 測試 3: 佇列資訊追蹤
- **目的**: 確認 `get_queue_info()` 正確追蹤活躍數量
- **方法**: 模擬 3 個請求進入並釋放，檢查計數器
- **結果**: ✅ 通過 - 活躍數從 0 → 3 → 0，可用位置從 5 → 2 → 5

### ✅ 測試 4: 超時機制驗證
- **目的**: 確認當佇列已滿時，新請求會在 timeout 後返回
- **方法**: 佔滿 5 個位置，嘗試獲取第 6 個位置 (timeout=3秒)
- **結果**: ✅ 通過 - 3.00 秒後正確超時返回 False

### ✅ 測試 5: 壓力測試
- **目的**: 驗證系統在高負載下的穩定性
- **方法**: 同時啟動 20 個並發請求
- **結果**: ✅ 通過 - 所有 20 個請求成功完成，耗時 2.00 秒

## 如何執行測試

### 在 Docker 環境中執行:
```bash
docker-compose exec backend python test_queue_mechanism.py
```

### 在本地環境執行:
```bash
cd backend
python test_queue_mechanism.py
```

## 測試結果解讀

```
🎉 所有測試通過! 排隊機制運作正常!
```

這表示:
1. ✅ Semaphore 正確限制最多 5 個並發請求
2. ✅ 超過限制的請求會正確排隊等待
3. ✅ 失敗時會自動重試 2 次（間隔 5秒、10秒）
4. ✅ 超時機制正常運作（300 秒 timeout）
5. ✅ 佇列資訊正確追蹤活躍數量
6. ✅ 系統在高並發下穩定運行

## 配置參數

測試使用以下配置（可透過環境變數調整）:

```python
MAX_CONCURRENT_IMAGE_GENERATION = 5    # 最多 5 個並發
IMAGE_GENERATION_TIMEOUT = 300         # 300 秒超時（測試時為 10 秒）
IMAGE_GENERATION_MAX_RETRIES = 2       # 最多重試 2 次
```

## 測試輸出範例

```
======================================================================
測試 1: 驗證並發限制 (最多 5 個同時執行)
======================================================================

啟動 10 個並發請求...
  ✓ 請求  0 開始執行 (活躍數: 0)
  ✓ 請求  1 開始執行 (活躍數: 0)
  ✓ 請求  2 開始執行 (活躍數: 0)
  ✓ 請求  3 開始執行 (活躍數: 0)
  ✓ 請求  4 開始執行 (活躍數: 0)
  ✓ 請求  0 完成
  ✓ 請求  5 開始執行 (活躍數: 0)
  ...

================================結果分析================================
總請求數: 10
成功請求: 10
失敗請求: 0
最大並發數: 5
✅ 測試通過: 所有請求都成功完成
```

## 故障排除

### 如果測試失敗:

1. **檢查 Semaphore 初始化**
   ```python
   # 在 gemini_service.py 中確認
   self.imagen_semaphore = threading.Semaphore(Config.MAX_CONCURRENT_IMAGE_GENERATION)
   ```

2. **檢查活躍數量追蹤**
   ```python
   # 確認 active_count 正確增減
   with self.queue_lock:
       self.active_count += 1  # 進入時
       self.active_count -= 1  # 離開時
   ```

3. **檢查 finally 區塊**
   ```python
   # 確保 Semaphore 一定會被釋放
   finally:
       self.imagen_semaphore.release()
   ```

## 注意事項

- 測試會短暫佔用系統資源（約 10-20 秒）
- Docker 環境中 google-genai 套件未安裝是正常的，不影響並發控制機制
- 壓力測試使用較短的處理時間 (0.5秒) 以加快測試速度
- 生產環境中，實際 API 呼叫時間可能更長 (15-30秒)

## 相關文件

- `gemini_service.py` - 並發控制實作
- `config.py` - 配置參數
- `app.py` - API 端點整合
